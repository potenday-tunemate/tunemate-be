<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper namespace="com.tunemate.be.domain.review.domain.ReviewMapper">

    <resultMap id="ReviewResultMap" type="com.tunemate.be.domain.review.domain.Review">
        <id property="id" column="review_id"/>
        <result property="content" column="review_content"/>
        <result property="createdAt" column="review_created_at"/>
        <result property="updatedAt" column="review_updated_at"/>

        <association property="user" javaType="com.tunemate.be.domain.user.domain.user.User">
            <id property="id" column="user_id"/>
            <result property="nickname" column="user_nickname"/>
        </association>

        <association property="album" javaType="com.tunemate.be.domain.album.domain.album.Album">
            <id property="id" column="album_id"/>
        </association>
    </resultMap>

    <select id="findAlbumReviewList" resultMap="ReviewResultMap">
        SELECT r.id         AS review_id,
               r.content    AS review_content,
               r.created_at AS review_created_at,
               r.updated_at AS review_updated_at,

               u.id         AS user_id,
               u.nickname   AS user_nickname,

               a.id         AS album_id,
        FROM review r
                 JOIN user u ON u.id = r.user
                 JOIN album a ON a.id = r.album
        WHERE r.id = #{id} LIMIT #{limit}
        OFFSET #{offset}
    </select>
    <insert id="create" parameterType="com.tunemate.be.domain.review.domain.Review" useGeneratedKeys="true"
            keyProperty="id">
        <selectKey resultType="int" keyProperty="id" order="AFTER">
            select max(id) from album_review
        </selectKey>
        INSERT INTO review (user, album, content)
        VALUES (#{user.id}, #{album.id}, #{content})
    </insert>
</mapper>
